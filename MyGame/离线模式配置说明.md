# Unity-HybridCLR-YooAsset 离线模式配置说明

## 修改内容总结

已成功将项目配置为**完全离线模式**，不依赖任何网络连接和资源下载。

---

## 一、修改的文件

### 1. GameStarter.cs
**修改位置**: `Assets/GameAssets/Code/Main/GameStarter.cs`

**修改内容**:
```csharp
// 修改前：真机运行时自动切换到 HostPlayMode（联机模式）
#if !UNITY_EDITOR
    if(PlayMode != EPlayMode.HostPlayMode)
    {
        PlayMode = EPlayMode.HostPlayMode;
        Debug.Log($"检测到真机运行,已切换运行模式至：{PlayMode}");
    }
#endif

// 修改后：注释掉自动切换逻辑，通过 Unity 检视面板手动设置
#if !UNITY_EDITOR
    // 注释掉自动切换逻辑，允许通过检视面板设置运行模式
    // if(PlayMode!= EPlayMode.HostPlayMode)
    // {
    //     PlayMode = EPlayMode.HostPlayMode;
    //     Debug.Log($"检测到真机运行,已切换运行模式至：{PlayMode}");
    // }
#endif
```

**作用**: 
- 移除了真机运行时的自动模式切换
- 允许通过 Unity 检视面板灵活设置运行模式
- 支持在编辑器和真机上使用不同的运行模式

---

### 2. PatchManager.cs
**修改位置**: `Assets/GameAssets/Code/Main/PatchLogic/PatchManager.cs`

**修改内容**:
```csharp
public void Run(EPlayMode playMode)
{
    // 离线模式：跳过所有网络相关状态
    if (playMode == EPlayMode.OfflinePlayMode)
    {
        Debug.Log("离线模式：跳过网络检查和资源下载");
        _machine.AddNode<FsmInitialize>();
        _machine.AddNode<FsmLoadHotUpdateDll>();
        _machine.AddNode<FsmPatchDone>();
        _machine.Run<FsmInitialize>();
    }
    else
    {
        // 在线模式：完整流程（保持原有逻辑）
        // ... 原有代码
    }
}
```

**作用**: 
- 离线模式只执行 3 个状态：初始化 → 加载DLL → 完成
- 跳过所有网络检查、版本更新、资源下载等状态
- 不注册网络相关的事件监听

---

### 3. FsmInitialize.cs
**修改位置**: `Assets/GameAssets/Code/Main/PatchLogic/FsmNode/FsmInitialize.cs`

**修改内容**:
```csharp
if (package.InitializeStatus == EOperationStatus.Succeed)
{
    // 离线模式直接跳转到加载 DLL
    if (PatchManager.Instance.PlayMode == EPlayMode.OfflinePlayMode)
    {
        Debug.Log("离线模式：初始化成功，直接加载热更新 DLL");
        _machine.ChangeState<FsmLoadHotUpdateDll>();
    }
    else
    {
        // 在线模式继续更新版本
        _machine.ChangeState<FsmUpdateVersion>();
    }
}
```

**作用**: 初始化成功后，离线模式直接跳转到加载 DLL，跳过版本更新流程

---

## 二、离线模式流程对比

### 原有流程（在线模式）
```
FsmPatchPrepare (准备)
    ↓
FsmCheckNetwork (检查网络) ❌
    ↓
FsmCheckVersion (检查版本) ❌
    ↓
FsmInitialize (初始化资源包)
    ↓
FsmUpdateVersion (更新版本号) ❌
    ↓
FsmUpdateManifest (更新资源清单) ❌
    ↓
FsmCreateDownloader (创建下载器) ❌
    ↓
FsmDownloadFiles (下载资源文件) ❌
    ↓
FsmDownloadOver (下载完成) ❌
    ↓
FsmLoadHotUpdateDll (加载热更新DLL)
    ↓
FsmClearCache (清理缓存) ❌
    ↓
FsmPatchDone (完成)
```

### 新流程（离线模式）
```
FsmInitialize (初始化资源包)
    ↓
FsmLoadHotUpdateDll (加载热更新DLL)
    ↓
FsmPatchDone (完成)
```

**优势**:
- ✅ 无需网络连接
- ✅ 启动速度更快
- ✅ 流程简单清晰
- ✅ 减少错误点

---

## 三、使用说明

### 1. 设置运行模式
在 Unity 编辑器中：
1. 找到场景中的 `GameStarter` 对象
2. 在检视面板（Inspector）中找到 `Play Mode` 属性
3. 根据需要选择运行模式：
   - **EditorSimulateMode**: 编辑器模拟模式（开发调试）
   - **OfflinePlayMode**: 离线模式（单机游戏）
   - **HostPlayMode**: 联机模式（需要网络）

### 2. 编辑器测试
- 设置 `PlayMode` 为 `OfflinePlayMode`
- 点击运行按钮测试

### 3. 真机运行
打包到真机后：
- 使用打包前在检视面板设置的运行模式
- 建议打包前设置为 `OfflinePlayMode`（离线）或 `HostPlayMode`（在线）

### 3. 资源准备
离线模式需要将所有资源打包到 APK/IPA 中：

#### 方法一：使用 StreamingAssets
```
1. 执行资源打包（BuildTools/BuildApk 或手动打包）
2. 将打包后的资源复制到 StreamingAssets 目录
3. 打包 APK/IPA
```

#### 方法二：使用 YooAsset 的 Buildin 文件系统
```csharp
// FsmInitialize.cs 中已配置
var createParameters = new OfflinePlayModeParameters();
createParameters.BuildinFileSystemParameters = 
    FileSystemParameters.CreateDefaultBuildinFileSystemParameters();
```

---

## 四、注意事项

### ⚠️ 资源更新
离线模式下：
- ❌ 无法进行热更新
- ❌ 无法下载新资源
- ✅ 所有资源必须打包到安装包中

### ⚠️ DLL 更新
离线模式下：
- ✅ 仍然支持加载热更新 DLL
- ⚠️ 但 DLL 必须打包到安装包中
- ❌ 无法从服务器下载新的 DLL

### ⚠️ 版本管理
离线模式下：
- ❌ 不检查版本号
- ❌ 不更新资源清单
- ✅ 使用打包时的资源版本

---

## 五、如何切换运行模式

### 方法一：通过检视面板设置（推荐）
1. 在 Unity 编辑器中选择场景中的 `GameStarter` 对象
2. 在检视面板中修改 `Play Mode` 属性：
   - `OfflinePlayMode`: 离线模式
   - `HostPlayMode`: 在线模式
   - `EditorSimulateMode`: 编辑器模拟模式
3. 保存场景

### 方法二：通过代码强制设置
如果需要在代码中强制设置运行模式，可以修改 `GameStarter.cs`：

```csharp
void Awake()
{
    // ... 其他代码
    
#if !UNITY_EDITOR
    // 真机运行时强制使用指定模式
    PlayMode = EPlayMode.OfflinePlayMode; // 或 HostPlayMode
    Debug.Log($"强制切换运行模式至：{PlayMode}");
#endif
}
```

### 方法三：根据条件动态切换
```csharp
void Awake()
{
    // ... 其他代码
    
#if !UNITY_EDITOR
    // 根据某些条件动态选择模式
    if (Application.internetReachability == NetworkReachability.NotReachable)
    {
        PlayMode = EPlayMode.OfflinePlayMode;
        Debug.Log("检测到无网络，切换到离线模式");
    }
    else
    {
        PlayMode = EPlayMode.HostPlayMode;
        Debug.Log("检测到有网络，切换到在线模式");
    }
#endif
}
```

---

## 六、构建离线包的完整步骤

### 步骤 1: 编译 DLL
```
菜单: BuildTools/BuildApk
或手动执行 BuildTools.BuildAOTDlls()
```

### 步骤 2: 复制 DLL 到资源目录
```
自动执行：
- CopyAOTDlls()
- CopyHotUpdateDlls()

结果：
- Assets/GameAssets/DLLs/AOTDll/*.dll.bytes
- Assets/GameAssets/DLLs/HotUpdateDll/*.dll.bytes
```

### 步骤 3: 打包 AssetBundle
```
执行 BuildTools.BuildAssetBundle()

输出目录：
- Bundles/{Platform}/DefaultPackage/{Version}/
```

### 步骤 4: 复制资源到 StreamingAssets
```
手动复制或修改 BuildTools.cs：

从: Bundles/{Platform}/DefaultPackage/{Version}/
到: Assets/StreamingAssets/
```

### 步骤 5: 打包 APK/IPA
```
执行 BuildTools.BuildAPK()
或使用 Unity 的 Build Settings
```

---

## 七、验证离线模式

### 检查点 1: 启动日志
```
资源系统运行模式：OfflinePlayMode（离线模式）
开启补丁更新流程...
离线模式：跳过网络检查和资源下载
初始化资源包！
离线模式：初始化成功，直接加载热更新 DLL
```

### 检查点 2: 状态流程
确认只执行了 3 个状态：
1. FsmInitialize
2. FsmLoadHotUpdateDll
3. FsmPatchDone

### 检查点 3: 无网络请求
- 断开网络连接
- 游戏仍能正常启动
- 无任何网络错误提示

---

## 八、常见问题

### Q1: 离线模式下资源加载失败？
**A**: 确保资源已正确打包到 StreamingAssets 或 APK 中

### Q2: DLL 加载失败？
**A**: 检查 DLL 文件是否存在于：
- `Assets/GameAssets/DLLs/AOTDll/`
- `Assets/GameAssets/DLLs/HotUpdateDll/`

### Q3: 如何验证资源是否打包？
**A**: 检查 APK 解压后的 `assets/bin/Data/StreamingAssets/` 目录

### Q4: 编辑器模式和离线模式的区别？
**A**: 
- **EditorSimulateMode**: 编辑器专用，直接从 Assets 加载
- **OfflinePlayMode**: 真机离线模式，从 StreamingAssets 加载

---

## 九、总结

通过以上修改，项目已完全支持离线模式：

✅ **优点**:
- 无需网络连接
- 启动速度快
- 流程简单
- 适合单机游戏

⚠️ **限制**:
- 无法热更新
- 资源必须预打包
- 更新需要发布新版本

🎯 **适用场景**:
- 单机游戏
- 内网环境
- 无网络环境
- 快速原型开发
